/*!
 * vuefire v2.0.0-alpha.20
 * (c) 2018 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Vuefire=t()}(this,function(){"use strict";function D(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function v(i,s,u,e){void 0===s&&(s={}),void 0===u&&(u=""),void 0===e&&(e=[{},{}]),s=s||{};var t=Object.getOwnPropertyDescriptor(i,"id");return t&&!t.enumerable&&Object.defineProperty(e[0],"id",t),Object.keys(i).reduce(function(e,t){var n,r,o=i[t];return(r=o)&&r.onSnapshot?(e[0][t]=s[t]||o.path,e[1][u+t]=o):Array.isArray(o)?(e[0][t]=Array(o.length).fill(null),v(o,s[t],u+t+".",[e[0][t],e[1]])):null==o||o instanceof Date||o.toDate||o.longitude&&o.latitude?e[0][t]=o:(n=o)&&"object"==typeof n?(e[0][t]={},v(o,s[t],u+t+".",[e[0][t],e[1]])):e[0][t]=o,e},e)}function R(e){for(var t in e)e[t].unsub()}function b(e,h){var v=e.subs,b=e.refs,y=e.target,g=e.path,m=(e.data,e.depth),j=e.ops,O=e.resolve,t=Object.keys(b);if(Object.keys(v).filter(function(e){return t.indexOf(e)<0}).forEach(function(e){v[e].unsub(),delete v[e]}),!t.length||++m>h.maxRefDepth)return O(g);var x=0,k=t.length,$=Object.create(null);t.forEach(function(e){var t,n,r,o,i,s,u,c,f,a,d=v[e],p=b[e],l=g+"."+e;if($[l]=!0,d){if(d.path===p.path)return;d.unsub()}v[e]={unsub:(t={ref:p,target:y,path:l,depth:m,ops:j,resolve:function(e){e in $&&++x>=k&&O(g)}.bind(null,l)},n=h,r=t.ref,o=t.target,i=t.path,s=t.depth,u=t.resolve,c=t.ops,f=Object.create(null),a=r.onSnapshot(function(e){e.exists?U({snapshot:D(e),target:o,path:i,ops:c,subs:f,depth:s,resolve:u},n):(c.set(o,i,null),u(i))}),function(){a(),R(f)}),path:p.path}})}function U(e,t){var n=e.snapshot,r=e.target,o=e.path,i=e.subs,s=e.ops,u=e.depth;void 0===u&&(u=0);var c=e.resolve;void 0===t&&(t={maxRefDepth:2});var f,a=v(n,(f=r,o.split(".").reduce(function(e,t){return e[t]},f))),d=a[0],p=a[1];s.set(r,o,d),b({data:d,subs:i,refs:p,target:r,path:o,ops:s,depth:u,resolve:c},t)}var o={set:function(e,t,n){return r=e,o=n,i=(""+t).split("."),s=i.pop(),(u=i.reduce(function(e,t){return e[t]},r)).splice?u.splice(s,1,o):u[s]=o;var r,o,i,s,u},add:function(e,t,n){return e.splice(t,0,n)},remove:function(e,t){return e.splice(t,1)}};function i(e,r){var o=e.vm,i=e.key,s=e.ref,u=e.ops;return void 0===r&&(r={maxRefDepth:2}),new Promise(function(e,t){var n;n=s.where?function(e,f){var i=e.vm,s=e.key,t=e.collection,a=e.ops,d=e.resolve,n=e.reject;void 0===f&&(f={maxRefDepth:2});var u,p=a.set(i,s,[]),c=d,l=[],h={added:function(e){var t=e.newIndex,n=e.doc;l.splice(t,0,Object.create(null));var r=l[t],o=v(D(n)),i=o[0],s=o[1];a.add(p,t,i),b({data:i,refs:s,subs:r,target:p,path:t,depth:0,ops:a,resolve:d.bind(null,n)},f)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,o=l.splice(t,1)[0];l.splice(n,0,o);var i=a.remove(p,t)[0],s=v(D(r),i),u=s[0],c=s[1];a.add(p,n,u),b({data:u,refs:c,subs:o,ops:a,target:p,path:n,depth:0,resolve:d},f)},removed:function(e){var t=e.oldIndex;a.remove(p,t),R(l.splice(t,1)[0])}},r=t.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!u&&t.length){u=!0;var n=0,r=t.length,o=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));d=function(e){e.id in o&&++n>=r&&(c(i[s]),d=function(e){})}}t.forEach(function(e){h[e.type](e)}),t.length||d()},n);return function(){r(),l.forEach(R)}}({vm:o,key:i,ops:u,collection:s,resolve:e,reject:t},r):function(e,t){var n,r,o,i=e.vm,s=e.key,u=e.document,c=e.resolve,f=e.reject,a=e.ops,d=Object.create(null);n=c,r=function(){return i[s]},c=function(){if(!o)return o=!0,n(r())};var p=u.onSnapshot(function(e){e.exists?U({snapshot:D(e),target:i,path:s,subs:d,ops:a,resolve:c},t):c()},f);return function(){p(),R(d)}}({vm:o,key:i,ops:u,document:s,resolve:e,reject:t},r),o._firestoreUnbinds[i]=n})}return function(e){var t=e.config.optionMergeStrategies;t.firestore=t.provide,e.mixin({created:function(){var t=this,e=this.$options.firestore;this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null);var n="function"==typeof e?e.call(this):e;n&&Object.keys(n).forEach(function(e){t.$bind(e,n[e])})},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}}),e.prototype.$bind=function(e,t,n){this._firestoreUnbinds[e]&&this.$unbind(e);var r=i({vm:this,key:e,ref:t,ops:o},n);return this.$firestoreRefs[e]=t,r},e.prototype.$unbind=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]}}});